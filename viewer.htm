<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
<title>Viewer - PrimaryDock</title>
<script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
<script src="https://unpkg.com/ngl@0.10.4/dist/ngl.js"></script>

<script>
var nglcitation
	= "AS Rose, AR Bradley, Y Valasatava, JM Duarte, A PrliÄ‡ and PW Rose.\n"
	+ "Web-based molecular graphics for large complexes.\n"
	+ "ACM Proceedings of the 21st International Conference on Web3D Technology (Web3D '16):\n"
	+ "185-186, 2016. doi:10.1145/2945292.2945324\n"
	+ "\n"
	+ "AS Rose and PW Hildebrand.\n"
	+ "NGL Viewer: a web application for molecular visualization.\n"
	+ "Nucl Acids Res (1 July 2015) 43 (W1):\n"
	+ "W576-W579 first published online April 29, 2015.\n"
	+ "doi:10.1093/nar/gkv402";

const aa1let = "ARNDCEQGHOILKMFPÃ–USTWYV";
const aa3let =
[
	'ALA', 'ARG', 'ASN', 'ASP', 'CYS',
	'GLU', 'GLN', 'GLY', 'HIS', 'HYP',
	'ILE', 'LEU', 'LYS', 'MET', 'PHE',
	'PRO', 'PYL', 'SEC', 'SER', 'THR',
	'TRP', 'TYR', 'VAL',
];

const aa_aliphatic = 0,
	aa_aromatic = 1,
	aa_hydrophilic = 2,
	aa_acidic = 3,
	aa_basic = 4,
	aa_sulfur = 5;

var opc_molecule = 1.0;
var opc_ligand = 1.0;
var opc_cartoon = 0.25;
var opc_sidechain = 0.46;
var opc_sidechain_active = 0.5;
var opc_metal = 1.0;

var mtl_bs = 0.0;
var mtl_licorice = 0.0;
var mtl_cartoon = 0.1;
var mtl_metal = 0.5;

var website = "www.primaryodors.org";
var is_localhost = false;

var test = "127.0.0.1";
if (!is_localhost) $.ajax(
{
	url: "http://" + test + "/instcheck.php",
	cache: false,
	success: function(result)
	{
		if (result == "b00d1cca")
		{
			website = test;
			is_localhost = true;
		}
	}
});

test = "127.0.0.1/primarydock";
if (!is_localhost) $.ajax(
{
	url: "http://" + test + "/instcheck.php",
	cache: false,
	success: function(result)
	{
		if (result == "b00d1cca")
		{
			website = test;
			is_localhost = true;
		}
	}
});

</script>
<style>
body
{
	color: #69c;
	width: 100%;
	height: 100%;
	overflow: hidden;
}

a
{	color: #2af;
	text-decoration: none;
}

a:hover
{
	text-decoration: underline;
}

#pleasewait
{
	position: fixed;
	top: 22%;
	left: 40%;
	right: 40%;
	width: 20%;
	text-align: center;
	background-color: rgba(0,11,31,0.67);
	color: #def;
	padding: 15px;
	border-radius: 25px;
	box-shadow: 0px 0px 41px rgba(0,0,0,0.22), 5px 3px 5px rgba(0,0,0,0.41);
}

#citefloat
{
	position: fixed;
	text-align: right;
    right: 25px;
    bottom: 15px;
	font-family: Verdana, Arial, Sans-Serif;
    font-size: 11px;
	color: #06c;
}

#citefloat span
{
    background-color: rgba(0,0,0,0.53);
	color: rgba(0, 128, 255, 0);
	font-size: 15px;
	transition: color 2s, height 2s;
	text-align: left;
	display: block;
	height: 0px;
	overflow: hidden;
}

#citefloat:hover span
{
	color: rgba(192, 192, 192, 1);
	display: block;
	height: auto;
}

#ctrls div
{
    margin-left: 15px;
}

#posey
{
	background-color: #123;
    min-width: 71px;
    padding-left: 5px;
    padding-right: 5px;
}

#dspsett
{
	position: absolute;
	top: 53px;
	border: 1px solid #039;
    padding: 5px;
    background-color: rgba(0, 32, 96, 0.67);
    border-radius: 13px;
}

.clickme, .clickme:hover
{
	cursor: pointer;
	text-decoration: none;
}

.clickme:hover
{
	color: #9cf;
}

.posebtn
{
	background-color: #246;
    border-top: 2px solid #47a;
    border-left: 2px solid #369;
    border-right: 2px solid #234;
    border-bottom: 2px solid #123;
    border-radius: 5px;
    padding-left: 3px;
    padding-right: 3px;
    margin-left: 2px;
    margin-right: 2px;
	cursor: pointer;
    font-size: 14px;
	font-family: Verdana, Arial, sans-serif;
}

.posebtn.hilite
{
	background-color: #369;
    border-top: 2px solid #68a;
    border-left: 2px solid #579;
    border-right: 2px solid #246;
    border-bottom: 2px solid #135;
}

.nodebtn
{
	background-color: #234;
    padding-left: 5px;
    padding-right: 5px;
    margin-left: 0px;
    margin-right: 0px;
	cursor: pointer;
    font-size: 14px;
	font-family: Verdana, Arial, sans-serif;
	display: inline-block;
}

.nodebtn.hilite
{
	background-color: #357;
}

.bw50
{
	color: #fff;
}

.symbol
{
	font-size: 20px!important;
}

.symbol.smaller
{
	font-size: 16px!important;
	line-height: 31px;
}

input, select
{
	background-color: #036;
	color: #9cf;
    border: 1px solid #06c;
    border-radius: 5px;
}

option.agonist
{
	background-color: #044;
	color: #9ef;
	font-weight: bold;
}

option.non_agonist
{
	background-color: #234;
	color: #bcd;
}

option.antagonist
{
	background-color: #410;
	color: #fb9;
}

option.unknown
{
	background-color: #000;
	color: #999;
}

#clip, #bbvis, #lght
{
    width: 503px;
}

#seqdd
{
	background-color: #223355cc;
	position: absolute;
	display: block;
	top: 25px;
	/*left: 225px;*/
	right: 5px;
	z-index: 1000;
	padding: 10px;
	border: 1px solid #249;
	border-radius: 15px;
	overflow-y: auto;
	max-height: 81%;
}

.sctgbtn
{
	font-family: Monospace;
	margin-bottom: 10px;
}

.sctgbtn.hilite
{
	border: 1px solid #35f;
    background-color: #345;
    color: #9cf;
    padding-left: 4px;
    padding-right: 4px;
}

.seqnumln
{
	font-family: Monospace;
	letter-spacing: 1.4px;
    margin-left: 5px;
    font-size: 13px;
}

.packtight
{
	letter-spacing: -4px!important;
}

</style>
<script>

// https://www.w3schools.com/jsref/met_element_exitfullscreen.asp
function openFullscreen(elem) 
{
	if (elem.requestFullscreen) 
	{
		elem.requestFullscreen();
	}
	else if (elem.webkitRequestFullscreen)
	{
		/* Safari */
		elem.webkitRequestFullscreen();
	}
	else if (elem.msRequestFullscreen) 
	{
		/* IE11 */
		elem.msRequestFullscreen();
	}
}
function exitFullscreen()
{
	if (document.exitFullscreen)
	{
		document.exitFullscreen();
	}
	else if (document.webkitExitFullscreen)
	{
		/* Safari */
		document.webkitExitFullscreen();
	}
	else if (document.msExitFullscreen) 
	{ 
		/* IE11 */
		document.msExitFullscreen();
	}
}
var is_fullscreen = false;

/******************************************************************************/
// http://stackoverflow.com/questions/901115/how-can-i-get-query-string-values-in-javascript
function getParameterByName(name, url)
{
    if (!url)
    {
        url = window.location.href;
    }
    name = name.replace(/[\[\]]/g, "\\$&");
    var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
    results = regex.exec(url);
    if (!results) return null;
    if (!results[2]) return '';
    return decodeURIComponent(results[2].replace(/\+/g, " "));
}
/******************************************************************************/

function rotate3D(point, source, axis, theta)
{
    // copied from http://inside.mines.edu/fs_home/gmurray/ArbitraryAxisRotation/

    if (!source)
    {
        source = {x:0, y:0, z:0};
    }

    if (!axis.x && !axis.y && !axis.z) return point;

    var x = point.x, y = point.y, z = point.z;
    var axisr = Math.sqrt(axis.x*axis.x + axis.y*axis.y + axis.z*axis.z);
    var u = axis.x / axisr, v = axis.y / axisr, w = axis.z / axisr;
    var a, b, c;
    if (source)
    {
        a = source.x;
        b = source.y;
        c = source.z;
    }
    else a = b = c = 0;
    var u2 = u*u;
    var v2 = v*v;
    var w2 = w*w;
    var sint = Math.sin(theta), cost = Math.cos(theta), _1_cost = (1.0 - cost);

    var x1 = (a * (v2+w2) - u * (b*v + c*w - u*x - v*y - w*z)) * _1_cost
           + x * cost
           + (-c*v + b*w - w*y + v*z) * sint;

    var y1 = (b * (u2+w2) - v * (a*u + c*w - u*x - v*y - w*z)) * _1_cost
           + y * cost
           + ( c*u - a*w + w*x - u*z) * sint;

    var z1 = (c * (u2+v2) - w * (a*u + b*v - u*x - v*y - w*z)) * _1_cost
           + z * cost
           + (-b*u + a*v - v*x + u*y) * sint;

    pt = {x:x1, y:y1, z:z1};
    return pt;
}

</script>
</head>
<body bgcolor="#000">
<div id="ctrls" style="display: flex; flex-wrap: wrap;">
    <div id="filediv">
		<input type="file">
    </div>

<div id="posey" title="Use the A-Z keys or the up and down arrow keys to choose poses when viewing dock results.">&nbsp;
</div>

<div id="pnodz"
     title="Use the 0-9 keys or the left and right arrow keys to choose nodes when viewing dock results. Shift+A-Z selects nodes 10 - 35."
     >&nbsp;
</div>

&nbsp;|&nbsp;

<div id="affichage">
	<a id="settbtn" class="nodebtn clickme symbol" onclick="show_hide_sett();" title="View Settings">&#9881;</a>
	<!-- a id="ptbbbtn" class="nodebtn clickme symbol" onclick="show_hide_gmdl();" title="Protein Backbone">&#xAA5C;</a -->
	<a id="sdchbtn" class="nodebtn clickme symbol" onclick="show_seqdd();" title="Side Chains">&#x232C;</a>
</div>
<a id="colcpk" title="Colors: CPK Standard" class="nodebtn clickme symbol smaller" onclick="born=true; if (sfenable) { spcfill ? spaceFill() : ballAndStick(); } refreshSideChainsVisible(); showNode(gnode); $(this).hide(); $('#colborn').show();">CPK</a>
<a id="colborn" title="Colors: Blue Oxygen, Red Nitrogen" class="nodebtn clickme symbol smaller" onclick="born=false; if (sfenable) { spcfill ? spaceFill() : ballAndStick(); } refreshSideChainsVisible(); showNode(gnode); $(this).hide(); $('#colcpk').show();" style="display: none;">BORN</a>
<a id="spcfill" title="Space Fill" class="nodebtn clickme symbol smaller" onclick="spaceFill(); refreshSideChainsVisible(); showNode(gnode); $(this).hide(); $('#bstick').show();">&#x1F388;</a>
<a id="bstick" title="Ball and Stick" class="nodebtn clickme symbol smaller" onclick="ballAndStick(); refreshSideChainsVisible(); showNode(gnode); $(this).hide(); $('#spcfill').show();" style="display: none;">&#x1F9B4;</a>
<a id="spinon" title="Spin On" class="nodebtn clickme symbol smaller" onclick="stage.setSpin(true); $(this).hide(); $('#spinoff').show();">&#x1F310;</a>
<a id="spinoff" title="Spin Off" class="nodebtn clickme symbol smaller" onclick="stage.setSpin(false); $(this).hide(); $('#spinon').show();" style="display: none;">&#x1F9F1;</a>

<div id="center">
<a id="fsbtn" class="nodebtn clickme" onclick="if (is_fullscreen) exitFullscreen(); else openFullscreen(document.body); is_fullscreen = !is_fullscreen">&#x26F6;</a>
Center:
<a class="posebtn clickme" onclick="gmodel[0].autoView(); cen_ligand = false;" title="Middle-click an atom to center it.">Model</a>
<a class="posebtn clickme" onclick="centerPocket(); cen_ligand = false;" id="pktbtn" style="display: none;">Pocket</a>
<a class="posebtn clickme" onclick="curr_ligand.autoView(); cen_ligand = true;" id="ligbtn" style="display: none;">Ligand</a>
</div>
</div>

<div id="dspsett" style="display: none;">
Clip:
<input type="range" id="clip" min="0" max="100" step="1" value="0" class="slider" onkeyup="this.blur();">
<span id="prsv">
<input type="checkbox" id="preserve" checked onchange="$('#clip').trigger('input');"> Preserve Ligand
</span>
<br>
Backbone:
<input type="range" id="bbvis" min="0" max="100" step="1" value="25" class="slider" onkeyup="this.blur();">
<br>
Lighting:
<input type="range" id="lght" min="0" max="170" step="1" value="80" class="slider" onkeyup="this.blur();">
</div>

<center>
<div id="viewport" style="width:1800px; height:880px; background-color: #020408;"></div>
</center>
<script>

function hsl_to_rgb(hue, sat, lum)
{
  sat /= 255;
  lum /= 255;
  const k = n => (n + hue / 30) % 12;
  const a = sat * Math.min(lum, 1 - lum);
  const f = n =>
    lum - a * Math.max(-1, Math.min(k(n) - 3, Math.min(9 - k(n), 1)));
  var r = 255 * f(0);
  var g = 255 * f(8);
  var b = 255 * f(4);
  
  return 0x10000*parseInt(r) + 0x100*parseInt(g) + parseInt(b);
}

// Can modify this array to your preferred TMR color scheme.
var tmcolor =
{
    1: hsl_to_rgb(350,  16, 128),
    2: hsl_to_rgb(200, 144, 160),
    3: hsl_to_rgb(150, 240, 176),
    4: hsl_to_rgb( 70,  96,  96),
    5: hsl_to_rgb( 60, 255, 176),
    6: hsl_to_rgb( 25, 240, 160),
    7: hsl_to_rgb(340, 225, 160),
};

var tmstart = {1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0}, tmend = {1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0};
var ligbs = [];
var mcres = [];
var bw50r = new Array(99).fill(0);

function aa_1let_from_3let(laa3let)
{
	var retval = "?";
	aa3let.forEach(function(item, index)
	{
		if (item == laa3let) retval = aa1let.substr(index, 1);
	});
	return retval;
}

function rgn_color(resno, tm_only = false)
{
	var i;

    for (i=1; i<=7; i++)
    {
        if (resno >= tmstart[i] && resno <= tmend[i]) return tmcolor[i];
        else if (!tm_only && resno < tmstart[i]) return (i&1) ? 0xccddee : 0xcc9966;
    }

    return tm_only ? 0 : 0xcc9966;
}

function rgn_color_dark(resno, tm_only = false)
{
	var couleur = rgn_color(resno, tm_only);
	var r = couleur & 0xff0000;
	var g = couleur & 0x00ff00;
	var b = couleur & 0x0000ff;

	r = Math.floor(r/4) & 0xff0000;
	g = Math.ceil(g/3) & 0x00ff00;
	b = Math.ceil(b/2);
	
	return r + g + b;
}

function css_color(rgb_int)
{
	return '#'+("000000" + rgb_int.toString(16)).substr(-6);
}

var tmoid = false;
function show_seqdd()
{
	var seqdd = $('#seqdd')[0];
	seqdd.innerHTML = "<b>Show/Hide Side Chains:</b><br><br>";

	var perline = 40;

	var i;
	var span = document.createElement("span");
	var dots = ". . . . . . . . .";
	var dotslen = dots.length;
	span.innerText = dots+"10 "+dots+"20 "+dots+"30 "+dots+"40 ";
	span.className = "seqnumln";
	span.appendChild(document.createElement("br"));
	seqdd.appendChild(span);
	var seqoff = 50;
	for (i=0; i<sequence.length; i++)
	{
		var tgl = document.createElement("span");
		if (typeof restoggled[i+1] == "undefined") restoggled[i+1] = 0;
		tgl.className = "clickme nodebtn sctgbtn" + (restoggled[i+1] ? " hilite" : "");
		var rcd = rgn_color_dark(i+1, true);
		if (rcd) tgl.style.backgroundColor = css_color(rcd);

		var j;
		for (j=1; j<67; j++) if (bw50r[j] == (i+1)) tgl.className += ' bw50';

		tgl.innerText = sequence.substr(i, 1);
		tgl.id = "seqddtgl" + (i+1);
		var ia = aa1let.indexOf(sequence.substr(i,1));
		tgl.title = (ia>=0) ? (aa3let[ia]+(i+1)) : (sequence.substr(i,1)+(i+1));
		tgl.setAttribute("onclick", "event.preventDefault(); toggleSideChain("+(i+1)+"); return false;");
		tgl.setAttribute("ondblclick", "event.preventDefault(); return false;");
		tgl.setAttribute("onmousedown", "event.preventDefault(); return false;");
		tgl.setAttribute("onmousemove", "event.preventDefault(); return false;");
		seqdd.appendChild(tgl);
		
		if (!((i+1)%perline))
		{
			seqdd.appendChild(document.createElement("br"));
			seqdd.appendChild(document.createElement("br"));
			span = document.createElement("span");
			
			var l;
			span.innerText = "";
			for (l=0; l<perline; l+=10)
			{
				if (seqoff >= 100) dots = dots.substr(0, dotslen-(seqoff.toString().length-2));
				span.innerText += dots+seqoff + " ";
				seqoff += 10;
			}
			
			span.className = "seqnumln";
			span.appendChild(document.createElement("br"));
			seqdd.appendChild(span);
		}
	}
	
	seqdd.appendChild(document.createElement("br"));
	seqdd.appendChild(document.createElement("br"));
	
	tgl = document.createElement("span");
	tgl.className = "clickme nodebtn sctgbtn";
	tgl.innerText = "Aliphatic";
	tgl.id = "seqddaliph";
	tgl.title = (ia>=0) ? (aa3let[ia]+(i+1)) : (sequence.substr(i,1)+(i+1));
	tgl.setAttribute("onclick", "event.preventDefault(); showSideChainsByType(aa_aliphatic); return false;");
	tgl.setAttribute("ondblclick", "event.preventDefault(); return false;");
	tgl.setAttribute("onmousedown", "event.preventDefault(); return false;");
	tgl.setAttribute("onmousemove", "event.preventDefault(); return false;");
	seqdd.appendChild(tgl);
	
	tgl = document.createElement("span");
	tgl.innerText = "|";
	seqdd.appendChild(tgl);
	
	tgl = document.createElement("span");
	tgl.className = "clickme nodebtn sctgbtn";
	tgl.innerText = "Aromatic";
	tgl.id = "seqddaroma";
	tgl.title = (ia>=0) ? (aa3let[ia]+(i+1)) : (sequence.substr(i,1)+(i+1));
	tgl.setAttribute("onclick", "event.preventDefault(); showSideChainsByType(aa_aromatic); return false;");
	tgl.setAttribute("ondblclick", "event.preventDefault(); return false;");
	tgl.setAttribute("onmousedown", "event.preventDefault(); return false;");
	tgl.setAttribute("onmousemove", "event.preventDefault(); return false;");
	seqdd.appendChild(tgl);
	
	tgl = document.createElement("span");
	tgl.innerText = "|";
	seqdd.appendChild(tgl);
	
	tgl = document.createElement("span");
	tgl.className = "clickme nodebtn sctgbtn";
	tgl.innerText = "Polar Uncharged";
	tgl.id = "seqddpolar";
	tgl.title = (ia>=0) ? (aa3let[ia]+(i+1)) : (sequence.substr(i,1)+(i+1)); 
	tgl.setAttribute("onclick", "event.preventDefault(); showSideChainsByType(aa_hydrophilic); return false;");
	tgl.setAttribute("ondblclick", "event.preventDefault(); return false;");
	tgl.setAttribute("onmousedown", "event.preventDefault(); return false;");
	tgl.setAttribute("onmousemove", "event.preventDefault(); return false;");
	seqdd.appendChild(tgl);
	
	tgl = document.createElement("span");
	tgl.innerText = "|";
	seqdd.appendChild(tgl);
	
	tgl = document.createElement("span");
	tgl.className = "clickme nodebtn sctgbtn";
	tgl.innerText = "Acidic";
	tgl.id = "seqddacid";
	tgl.title = (ia>=0) ? (aa3let[ia]+(i+1)) : (sequence.substr(i,1)+(i+1)); 
	tgl.setAttribute("onclick", "event.preventDefault(); showSideChainsByType(aa_acidic); return false;");
	tgl.setAttribute("ondblclick", "event.preventDefault(); return false;");
	tgl.setAttribute("onmousedown", "event.preventDefault(); return false;");
	tgl.setAttribute("onmousemove", "event.preventDefault(); return false;");
	seqdd.appendChild(tgl);
	
	tgl = document.createElement("span");
	tgl.innerText = "|";
	seqdd.appendChild(tgl);
	
	tgl = document.createElement("span");
	tgl.className = "clickme nodebtn sctgbtn";
	tgl.innerText = "Basic";
	tgl.id = "seqddbasic";
	tgl.title = (ia>=0) ? (aa3let[ia]+(i+1)) : (sequence.substr(i,1)+(i+1)); 
	tgl.setAttribute("onclick", "event.preventDefault(); showSideChainsByType(aa_basic); return false;");
	tgl.setAttribute("ondblclick", "event.preventDefault(); return false;");
	tgl.setAttribute("onmousedown", "event.preventDefault(); return false;");
	tgl.setAttribute("onmousemove", "event.preventDefault(); return false;");
	seqdd.appendChild(tgl);
	
	tgl = document.createElement("span");
	tgl.innerText = "|";
	seqdd.appendChild(tgl);
	
	tgl = document.createElement("span");
	tgl.className = "clickme nodebtn sctgbtn";
	tgl.innerText = "Sulfur";
	tgl.id = "seqddsulfur";
	tgl.title = (ia>=0) ? (aa3let[ia]+(i+1)) : (sequence.substr(i,1)+(i+1)); 
	tgl.setAttribute("onclick", "event.preventDefault(); showSideChainsByType(aa_sulfur); return false;");
	tgl.setAttribute("ondblclick", "event.preventDefault(); return false;");
	tgl.setAttribute("onmousedown", "event.preventDefault(); return false;");
	tgl.setAttribute("onmousemove", "event.preventDefault(); return false;");
	seqdd.appendChild(tgl);
	
	tgl = document.createElement("br");
	// tgl.innerText = "|";
	seqdd.appendChild(tgl);
	
	tgl = document.createElement("span");
	tgl.className = "clickme nodebtn sctgbtn";
	tgl.innerText = "Ligand Binding";
	tgl.id = "seqddligbs";
	tgl.title = (ia>=0) ? (aa3let[ia]+(i+1)) : (sequence.substr(i,1)+(i+1)); 
	tgl.setAttribute("onclick", "event.preventDefault(); showLigandSideChains(); return false;");
	tgl.setAttribute("ondblclick", "event.preventDefault(); return false;");
	tgl.setAttribute("onmousedown", "event.preventDefault(); return false;");
	tgl.setAttribute("onmousemove", "event.preventDefault(); return false;");
	seqdd.appendChild(tgl);
	
	tgl = document.createElement("span");
	tgl.innerText = "|";
	seqdd.appendChild(tgl);
	
	tgl = document.createElement("span");
	tgl.className = "clickme nodebtn sctgbtn";
	tgl.innerText = "Metal Coord";
	tgl.id = "seqddmcoord";
	tgl.title = (ia>=0) ? (aa3let[ia]+(i+1)) : (sequence.substr(i,1)+(i+1)); 
	tgl.setAttribute("onclick", "event.preventDefault(); showMetalSideChains(); return false;");
	tgl.setAttribute("ondblclick", "event.preventDefault(); return false;");
	tgl.setAttribute("onmousedown", "event.preventDefault(); return false;");
	tgl.setAttribute("onmousemove", "event.preventDefault(); return false;");
	seqdd.appendChild(tgl);
	
	tgl = document.createElement("span");
	tgl.innerText = "|";
	seqdd.appendChild(tgl);
	
	tgl = document.createElement("span");
	tgl.className = "clickme nodebtn sctgbtn";
	tgl.innerText = "All";
	tgl.id = "seqddall";
	tgl.title = (ia>=0) ? (aa3let[ia]+(i+1)) : (sequence.substr(i,1)+(i+1));
	tgl.setAttribute("onclick", "event.preventDefault(); showAllSideChains(); return false;");
	tgl.setAttribute("ondblclick", "event.preventDefault(); return false;");
	tgl.setAttribute("onmousedown", "event.preventDefault(); return false;");
	tgl.setAttribute("onmousemove", "event.preventDefault(); return false;");
	seqdd.appendChild(tgl);
	
	tgl = document.createElement("span");
	tgl.innerText = "|";
	seqdd.appendChild(tgl);

	tgl = document.createElement("span");
	tgl.className = "clickme nodebtn sctgbtn";
	tgl.innerText = "None";
	tgl.id = "seqddnone";
	tgl.title = (ia>=0) ? (aa3let[ia]+(i+1)) : (sequence.substr(i,1)+(i+1));
	tgl.setAttribute("onclick", "event.preventDefault(); hideAllSideChains(); return false;");
	tgl.setAttribute("ondblclick", "event.preventDefault(); return false;");
	tgl.setAttribute("onmousedown", "event.preventDefault(); return false;");
	tgl.setAttribute("onmousemove", "event.preventDefault(); return false;");
	seqdd.appendChild(tgl);
	
	
	var sdchbtn = $('#sdchbtn')[0];
	var btnrect = sdchbtn.getBoundingClientRect();
	$(seqdd
		).css("top", parseInt(btnrect.bottom).toString()+"px"
		// ).css("left", parseInt(btnrect.left).toString()+"px"
		).toggle().on("mouseleave", function()
		{
			if (tmoid) window.clearTimeout(tmoid);
			tmoid = window.setTimeout(function()
			{
				$('#seqdd').hide();
			}, 1000);
		}).on("mousemove", function()
		{
			if (tmoid) window.clearTimeout(tmoid);
		});
	
}

var stage = new NGL.Stage("viewport");
var gmodel = [], model = [], is_ligand = [], mrep = [], gmrep = [], mrparams = [], gmrparams = [], mpos = [], mnod = [];
var resmdl = [], mdlresno = [], restoggled = [];
var acvmdl = false;
var acvmatrix = [], acvrot8 = [];
var acvnode = 387420489;
var curr_ligand = false, cen_ligand = false;
var gpose = 1, gnode = 0;
var orid;
var mtlcoord = [];
var sequence = "";
var pocket = [0,0,0];

$("#affichage").hide();

var gmdl_shown = true;
function show_hide_gmdl()
{
	if (gmdl_shown)
	{
		gmodel[0].removeAllRepresentations();
	}
	else
	{
		gmodel[0].addRepresentation( "cartoon",
		{
			opacity: opc_cartoon,
			colorScheme: PODefRgnScheme,
			metalness: mtl_cartoon,
		});
	}
	gmdl_shown = !gmdl_shown;
	set_gmdl_opacity();
}

function set_gmdl_opacity()
{
	if (typeof gmodel[0] == 'undefined') return;
	if ($("#affichage")[0].style.display == 'none') return;
	var opc = parseFloat($("#bbvis")[0].value) / 100;
	if (gmdl_shown)
	{
		gmodel[0].removeAllRepresentations();
		gmodel[0].addRepresentation( "cartoon",
		{
			opacity: opc,
			colorScheme: PODefRgnScheme,
			metalness: mtl_cartoon,
		});
	}
}

function show_hide_sett()
{
	var sett = $("#dspsett");
	var rect = $("#ctrls")[0].getClientRects()[0];
	sett[0].style.top = (parseInt(rect.bottom)+5) + "px";
	rect = $("#settbtn")[0].getClientRects()[0];
	sett[0].style.left = (parseInt(rect.left)+0) + "px";
	sett.toggle().on("mouseleave", function()
	{
		if (tmoid) window.clearTimeout(tmoid);
		tmoid = window.setTimeout(function()
		{
			$('#dspsett').hide();
		}, 1000);
	}).on("mousemove", function()
	{
		if (tmoid) window.clearTimeout(tmoid);
	});

	sett.show();
}

window.onresize = function()
{
    var w = parseInt(window.visualViewport.width - $("#viewport")[0].getBoundingClientRect().top - 5);
    var h = parseInt(window.visualViewport.height - 5);
    $('#viewport').css("width", w+"px").css("height",h+"px");
    stage.setSize(w, h);
};
window.onresize();

stage.mouseControls.add( "scroll-ctrl+shift", function( stage, delta )
{
    var ai = stage.getParameters().ambientIntensity;
    stage.setParameters( { ambientIntensity: Math.max( 0, ai + delta / 50 ) } );
} );

stage.mouseControls.add("clickPick", function(stage, e)
{
	toggleSideChain(e.atom.resno);
});

function centerPocket()
{
	stage.viewerControls.center( 
	{
		x: pocket[0],
		y: pocket[1],
		z: pocket[2],
	});
}

function get_clip_value()
{
	var v = parseFloat($("#clip")[0].value);
	v /= 50;
	v -= 1;
	v = Math.sign(v) * Math.pow(Math.abs(v), 3);
	v += 1;
	v *= 50;
	return v;
}

function showSideChain(resno)
{
	try
	{
		var clipValue = get_clip_value();
		if (!restoggled[resno])
		{
			var mdlidx = mdlresno.indexOf(resno);
			resmdl[mdlidx].addRepresentation( spcfill ? "spacefill" : "licorice",
            {
                "opacity": spcfill ? 1 : opc_sidechain,
				"colorScheme": PODefScheme,
                "metalness": mtl_licorice,
                "clipNear": clipValue,
            });
			restoggled[resno] = 1;
			$('#seqddtgl'+resno).addClass('hilite');
		}
	}
	catch (ex)
	{
		;
	}
	set_gmdl_opacity();
}

function toggleSideChain(resno)
{
	try
	{
		var mdlidx = mdlresno.indexOf(resno);
		if (restoggled[resno])
		{
			resmdl[mdlidx].removeAllRepresentations();
			restoggled[resno] = 0;
			$('#seqddtgl'+resno).removeClass('hilite');
		}
		else
		{
			showSideChain(resno);
		}
	}
	catch (ex)
	{
		;
	}
	set_gmdl_opacity();
}

function refreshSideChainsVisible()
{
	try
	{
		var clipValue = get_clip_value();
		var i;
		for (i=0; i<restoggled.length; i++)
		{
			if (restoggled[i])
			{
				resmdl[i].removeAllRepresentations();
				resmdl[i].addRepresentation( spcfill ? "spacefill" : "licorice",
				{
					"opacity": spcfill ? 1 : opc_sidechain,
					"colorScheme": PODefScheme,
					"metalness": mtl_licorice,
					"clipNear": clipValue,
				});
			}
		}
	}
	catch (ex)
	{
		;
	}
}

function showAllSideChains()
{
	var resno = 1;
	while (typeof restoggled[resno] != "undefined")
	{
		showSideChain(resno);
		resno++;
	}
}

function hideAllSideChains()
{
	var resno = 1;
	while (typeof restoggled[resno] != "undefined")
	{
		var mdlidx = mdlresno.indexOf(resno);
		if (mdlidx > 0)
		{
			resmdl[mdlidx].removeAllRepresentations();
			restoggled[resno] = 0;
			$('#seqddtgl'+resno).removeClass('hilite');
		}
		resno++;
	}
}

function showSideChainsByType(show_type)
{
	var resdict = [];

	for (var key in gmodel[0].structure.residueMap.dict)
	{
		// if (!gmodel[0].structure.residueMap.dict.hasOwnProperties(key)) continue;
		resdict[gmodel[0].structure.residueMap.dict[key]] = key.split("|")[0];
	}

	var resno = 1;
	while (typeof restoggled[resno] != "undefined")
	{
		var idx = gmodel[0].structure.residueStore.resno.indexOf(resno);
		if (idx >= 0)
		{
			var aa = resdict[gmodel[0].structure.residueStore.residueTypeId[idx]];

			var show_sc = false;
			switch(aa)
			{
				case 'MET':
					show_sc = (show_type == aa_aliphatic || show_type == aa_sulfur);
					break;
				case 'ALA': case 'ILE': case 'LEU': case 'VAL': case 'PRO': case 'GLY':
					show_sc = (show_type == aa_aliphatic);
					break;
				case 'CYS':
					show_sc = (show_type == aa_sulfur);
					break;
				case 'PHE': case 'TRP': case 'TYR':
					show_sc = (show_type == aa_aromatic);
					break;
				case 'HIS':
					show_sc = (show_type == aa_aromatic || show_type == aa_basic);
					break;
				case 'ARG': case 'LYS':
					show_sc = (show_type == aa_basic);
					break;
				case 'ASP': case 'GLU':
					show_sc = (show_type == aa_acidic);
					break;
				case 'SER': case 'THR': case 'ASN': case 'GLN':
					show_sc = (show_type == aa_hydrophilic);
					break;
			}

			if (show_sc) showSideChain(resno);
		}

		resno++;
	}
}

function showLigandSideChains()
{
	var i;
	for (i=0; i<ligbs.length; i++)
	{
		showSideChain(ligbs[i]);
	}
}

function showMetalSideChains()
{
	var i;
	for (i=0; i<mcres.length; i++)
	{
		showSideChain(mcres[i]);
	}
}

function ballAndStick()
{
	var i;
	for (i=0; i<gmodel.length && i<gmrparams.length && i<gmrep.length; i++)
	{
		if (gmrep[i] == "ball+stick")
		{
			gmodel[i].removeAllRepresentations();
			gmodel[0].addRepresentation(gmrep[i], gmrparams[0]);
		}
	}
	spcfill = false;
}

function spaceFill()
{
	var i;
	for (i=0; i<gmodel.length && i<gmrparams.length && i<gmrep.length; i++)
	{
		if (gmrep[i] == "ball+stick")
		{
			gmodel[i].removeAllRepresentations();
			gmodel[0].addRepresentation("spacefill", gmrparams[0]);
		}
	}
	spcfill = true;
}

function disable_spacefill()
{
	return;
	$('#spcfill').hide();
	$('#bstick').hide();
	sfenable = false;
}

function enable_spacefill()
{
	spcfill ? $('#spcfill').hide() : $('#spcfill').show();
	spcfill ? $('#bstick').show() : $('#bstick').hide();
	spcfill ? spaceFill() : ballAndStick();
	sfenable = true;
}

var born = false;
var spcfill = false;
var sfenable = true;
if (getParameterByName("born"))
{
	born = true;
	$("#colborn").show();
	$("#colcpk").hide();
}
var PODefScheme = NGL.ColormakerRegistry.addScheme(function (params)
{
    this.atomColor = function(atom)
    {
		if (typeof atom.atomType == "undefined") return 0xff99ff;
    	var elem = atom.element;
        if (atom.resno <= 1)
        {
        	elem = atom.atomname.replace(/[^A-Za-z]/g, '');
        	elem = elem.charAt(0).toUpperCase() + elem.slice(1).toLowerCase();
    	}
        switch (elem)
        {
        	case 'H': return atom.isBackbone() ? 0x79949b : 0xd1f5ff;
			case 'He': return 0xfcaa93;
			case 'Ne': return 0xff4e00;
            
        	case 'C':
            if (atom.isBackbone()) return 0x666666;
            else switch (atom.resname)
            {
                case 'GLY':
                return 0x999999;

                case 'ALA':
                case 'ILE':
                case 'LEU':
                case 'PRO':
                case 'VAL':
                return 0x808080;

                case 'MET':
                case 'CYS':
                case 'SEC':
                return 0x99aa77;

                case 'PHE':
                case 'TRP':
                case 'TYR':
                return 0x664466;

                case 'SER':
                case 'THR':
                case 'GLN':
                case 'ASN':
                return 0x55aa93;

                case 'ASP':
                case 'GLU':
                return born ? 0x99bbdd : 0xddbb99;

                case 'HIS':
                case 'LYS':
                case 'ARG':
                case 'PYL':
                return born ? 0xddbb99 : 0x99bbdd;

                default:
                return 0x666666;
            }

        	case 'N': return born ? (atom.isBackbone() ? 0x660033 : 0xFF3300) : (atom.isBackbone() ? 0x000066 : 0x0033FF);
        	case 'O': return born ? (atom.isBackbone() ? 0x003366 : 0x0099FF) : (atom.isBackbone() ? 0x660000 : 0xFF0000);
        	case 'P': return 0xff77c6;
        	case 'S': return 0xffdd00;
        	case 'Se': return 0xffaa00;
        	case 'Cl': return 0x339900;
        	case 'Br': return 0x993300;
        	case 'I': return 0x990033;
        	case 'Cu': return 0xe5a072;
        	case 'Zn': return 0x92b0cc;
        	case 'Na': return 0xffcc00;
        	case 'Mg': return 0x99ffcc;
        	case 'K': return 0x9966ff;
        	case 'Ca': return 0xf7f7f7;
        	case 'Fe': return 0x845f42;

        	default: return 0x99aabb;
        }

        return 0xcc00ff;
    };
});

var PODefSchemeHilite = NGL.ColormakerRegistry.addScheme(function (params)
{
    this.atomColor = function(atom)
    {
		if (typeof atom.atomType == "undefined") return 0xff99ff;
    	var elem = atom.atomType.element;
        if (atom.resno <= 1)
        {
        	elem = atom.atomname.replace(/[^A-Za-z]/g, '');
        	elem = elem.charAt(0).toUpperCase() + elem.slice(1).toLowerCase();
    	}
        switch (elem)
        {
        	case 'H': return atom.isBackbone() ? 0x79949b : 0xe1faff;
			case 'He': return 0xfcaa93;
			case 'Ne': return 0xff4e00;
            
        	case 'C':
            if (atom.isBackbone()) return 0x666666;
            else switch (atom.resname)
            {
                case 'GLY':
                return 0xe0e0e0;

                case 'ALA':
                case 'ILE':
                case 'LEU':
                case 'PRO':
                case 'VAL':
                return 0xbbccbb;

                case 'MET':
                case 'CYS':
                case 'SEC':
                return 0xddee99;

                case 'PHE':
                case 'TRP':
                case 'TYR':
                return 0xaa88aa;

                case 'SER':
                case 'THR':
                case 'GLN':
                case 'ASN':
                return 0x77eed5;

                case 'ASP':
                case 'GLU':
                return born ? 0xbbddff : 0xffddbb;

                case 'HIS':
                case 'LYS':
                case 'ARG':
                case 'PYL':
                return born ? 0xffddbb : 0xbbddff;

                default:
                return 0x777777;
            }

        	case 'N': return born ? (atom.isBackbone() ? 0x660033 : 0xFF3300) : (atom.isBackbone() ? 0x000066 : 0x0033FF);
        	case 'O': return born ? (atom.isBackbone() ? 0x003366 : 0x0099FF) : (atom.isBackbone() ? 0x660000 : 0xFF2222);
        	case 'P': return 0xff8add;
        	case 'S': return 0xffe022;
        	case 'Se': return 0xffb022;
        	case 'Cl': return 0x339900;
        	case 'Br': return 0x993300;
        	case 'I': return 0x990033;
        	case 'Cu': return 0xe5a072;
        	case 'Zn': return 0x92b0cc;
        	case 'Na': return 0xffcc00;
        	case 'Mg': return 0x99ffcc;
        	case 'K': return 0x9966ff;
        	case 'Ca': return 0xf7f7f7;
        	case 'Fe': return 0x845f42;

        	default: return 0x99aabb;
        }

        return 0xcc00ff;
    };
});

var PODefSchemeLigand = NGL.ColormakerRegistry.addScheme(function (params)
{
    this.atomColor = function(atom)
    {
		if (typeof atom.atomType == "undefined") return 0xff99ff;
    	var elem = atom.atomType.element;
        if (atom.resno <= 1)
        {
        	elem = atom.atomname.replace(/[^A-Za-z]/g, '');
        	elem = elem.charAt(0).toUpperCase() + elem.slice(1).toLowerCase();
    	}
        switch (elem)
        {
        	case 'H': return 0xe1faff;
			case 'He': return 0xfcaa93;
        	case 'C': return 0xa7ada4;
        	case 'N': return born ? 0xFF3300 : 0x5555FF;
        	case 'O': return born ? 0x0099FF : 0xFF2222;
			case 'Ne': return 0xff4e00;
        	case 'P': return 0xff8add;
        	case 'S': return 0xffe022;
        	case 'Se': return 0xffb022;
        	case 'Cl': return 0x339900;
        	case 'Br': return 0x993300;
        	case 'I': return 0x990033;
        	case 'Cu': return 0xe5a072;
        	case 'Zn': return 0x92b0cc;
        	case 'Na': return 0xffcc00;
        	case 'Mg': return 0x99ffcc;
        	case 'K': return 0x9966ff;
        	case 'Ca': return 0xf7f7f7;
        	case 'Fe': return 0x845f42;

        	default: return 0x99aabb;
        }

        return 0xcc00ff;
    };
});

var PODefSchemeRainbow = NGL.ColormakerRegistry.addScheme(function (params)
{
	/**/

	this.atomColor = function(atom) 
	{
		if (isNaN(atom.structure.rnbPos))
		{
			var morceaux = atom.structure.name.split("|");

			var i;
			var nmax = 0;

			for (i=0; i<model.length; i++)
			{
				if (mpos[i] == gpose && mnod[i] > nmax) nmax = mnod[i];
			}

			var nodeNo = parseInt(morceaux[1]);
			atom.structure.rnbPos = 0.9 + (0.02 + nodeNo) / (0.5+nmax);
		}

		var rnbint = parseInt(255*atom.structure.rnbPos)
		var acol = hsl_to_rgb(rnbint, 81, 173);
		return acol;
	}
});

var PODefRgnScheme = NGL.ColormakerRegistry.addScheme(function (params)
{
    this.atomColor = function(atom)
    {
        var resno = atom.resno;
        var rgnc = rgn_color(resno, true);

		if (!rgnc)
		{
			switch (atom.resname.toUpperCase())
			{
				case "MET":
				return 0xcccc99;
				
				case "ALA": case "ILE": case "LEU": case "VAL":
				return 0xcccccc;

				case "PRO":
				return 0x999999;

				case "GLY":
				return 0x666666;

				case "CYS":
				return 0xcccc33;

				case "SER": case "THR":
				return 0x66cc99;

				case "ASN": case "GLN":
				return 0x33cc99;

				case "ASP": case "GLU":
				return 0xff6666;

				case "ARG": case "LYS": case "HIS":
				return 0x3333ff;

				case "PHE": case "TRP": case "TYR":
				return 0xcc99cc;

				default:
				return 0xcc9966;
			}
		}

		return rgnc;
    }
});

stage.setParameters(
{
	'backgroundColor': '#020408',
	'ambientColor': '#59f',
    'ambientIntensity': 0.6,
	'lightColor': '#fc8',
    'lightIntensity': 0.8,
});

// These do not work in Chrome on Linux.
stage.mouseControls.remove( "scroll-ctrl" );
stage.mouseControls.remove( "scroll-shift" );
stage.mouseControls.remove( "scroll-alt" );

// Things better stay where they are.
stage.mouseControls.remove( "drag-ctrl-right ");
stage.mouseControls.remove( "drag-ctrl-left ");

function apply_pdb(poresult)
{
	var i;
	var shiny = [];
	var result = poresult.split("\n");
	var lres = 0;
	var tmpstr = "";
	for (i=0; i<result.length; i++)
	{
		var ln = result[i];
		var resno = parseInt(ln.substr(22,4));
		var aname = ln.substr(12,4).trim();
		if (ln.substr(17,3) == "MTL") shiny.push(ln);
		
		if (lres != resno)
		{
			if (ln.length > 20)
			{
				var aa1let = aa_1let_from_3let(ln.substr(17,3).trim());
				if (aa1let != '?')
				{
					var stringBlob5 = new Blob( [tmpstr], { type: 'text/plain'} );
					stage.loadFile( stringBlob5, { ext: 'pdb' } ).then( function( comp5 )
					{
						resmdl.push(comp5);
						restoggled.push(0);
						disable_spacefill();
					});
					mdlresno.push(resno);
					
					lres = resno;
					tmpstr = "";
					
					sequence += aa1let;
					
					$('#clip').trigger("input");
				}
			}
		}
		if (ln.length < 20) continue;
		
		tmpstr += ln + "\n";
		
		$('#clip').trigger("input");
	}
	if (tmpstr)
	{
		var stringBlob5a = new Blob( [tmpstr], { type: 'text/plain'} );
		stage.loadFile( stringBlob5a, { ext: 'pdb' } ).then( function( comp5a )
		{
			resmdl.push(comp5a);
			restoggled.push(0);
			disable_spacefill();
			$('#clip').trigger("input");
		});
		mdlresno.push(resno);
	}

	var stringBlob3 = new Blob( [ poresult ], { type: 'text/plain'} );
	stage.loadFile( stringBlob3, { ext: 'pdb' } ).then( function( comp3 )
	{
		var rp =
		{
			opacity: opc_cartoon,
			colorScheme: PODefRgnScheme,
			metalness: mtl_cartoon,
		};
		comp3.addRepresentation( "cartoon", rp);
		comp3.setName("backbone");
		gmodel.push(comp3);
		gmrep.push("cartoon");
		gmrparams.push(rp);
		disable_spacefill();
		$('#clip').trigger("input");
		
		if (acvrot8.length)
		{
			var j;
			if (!acvmdl)
			{
				for (j=0; j<gmodel.length; j++)
				{
					if (gmodel[j].name == "backbone")
					{
						// acvmdl = JSON.parse(JSON.stringify(gmodel[j]));
						stage.loadFile( stringBlob3, { ext: 'pdb' } ).then( function( comp8 )
						{
							acvmdl = comp8;
							
							if (acvmdl)
							{
								// Call the NGL functions to get the proxies etc.
								acvmdl.structure.eachResidue(function(res_proxy)
								{
									var i;
									for (i=0; i<acvrot8.length; i++)
									{
										if (res_proxy.resno >= acvrot8[i].sr && res_proxy.resno <= acvrot8[i].er)
										{
											var lrot8 = acvrot8[i];
											var ox = lrot8.ox, oy = lrot8.oy, oz = lrot8.oz;
											var ax = lrot8.ax, ay = lrot8.ay, az = lrot8.az;
											var origin = { x:ox, y:oy, z:oz };
											var axis   = { x:ax, y:ay, z:az };
											res_proxy.eachAtom(function(a_proxy)
											{
												var rotated = rotate3D( 
													{
														x:a_proxy.x + acvrot8[i].tx, 
														y:a_proxy.y + acvrot8[i].ty,
														z:a_proxy.z + acvrot8[i].tz
													},
													origin,
													axis,
													acvrot8[i].angle
												);
												a_proxy.x = rotated.x;
												a_proxy.y = rotated.y;
												a_proxy.z = rotated.z;
											});
										}
									}		// end each acvrot8.
								});		// end each residue.
							}		// end if acvmdl.
						});
						break;
					}		// end if name backbone.
				}		// end for gmodel.
			}		// end if not acvmdl.
		}		// if acvrot8 length
		else if (acvmatrix.length)
		{
			var j;
			if (!acvmdl)
			{
				for (j=0; j<gmodel.length; j++)
				{
					if (gmodel[j].name == "backbone")
					{
						// acvmdl = JSON.parse(JSON.stringify(gmodel[j]));
						stage.loadFile( stringBlob3, { ext: 'pdb' } ).then( function( comp8 )
						{
							acvmdl = comp8;
							
							if (acvmdl)
							{
								// Call the NGL functions to get the proxies etc.
								acvmdl.structure.eachResidue(function(res_proxy)
								{
									var i;
									for (i=0; i<acvmatrix.length; i++)
									{
										if (res_proxy.resno >= acvmatrix[i].sr && res_proxy.resno <= acvmatrix[i].er)
										{
											var f = parseFloat(res_proxy.resno - acvmatrix[i].sr) / (acvmatrix[i].er - acvmatrix[i].sr);
											var mx = f * acvmatrix[i].cx + (1.0-f) * acvmatrix[i].nx;
											var my = f * acvmatrix[i].cy + (1.0-f) * acvmatrix[i].ny;
											var mz = f * acvmatrix[i].cz + (1.0-f) * acvmatrix[i].nz;
											
											res_proxy.eachAtom(function(a_proxy)
											{
												a_proxy.x += mx;
												a_proxy.y += my;
												a_proxy.z += mz;
											});
										}
									}		// end each acvmatrix.
								});		// end each residue.
							}		// end if acvmdl.
						});
						break;
					}		// end if name backbone.
				}		// end for gmodel.
			}		// end if not acvmdl.

			
		}		// end if acvmatrix length.
	});

	if (shiny.length)
	{
		var stringBlob4 = new Blob( [ shiny.join("\n") ], { type: 'text/plain'} );
		stage.loadFile( stringBlob4, { ext: 'pdb' } ).then( function( comp4 )
		{
			var rp = 
			{
				opacity: opc_metal,
				colorScheme: PODefScheme,
				metalness: mtl_metal,
			};
			comp4.addRepresentation( "spacefill", rp);
			gmodel.push(comp4);
			gmrep.push("spacefill");
			gmrparams.push(rp);
			disable_spacefill();
			$('#clip').trigger("input");
		});
	}
	
	set_gmdl_opacity();
}

var url = getParameterByName('url') ? getParameterByName('url') : 'http://'+website+'/sdf.php';
var molid = getParameterByName('mol') ? getParameterByName('mol') : 'rand';
var protid = getParameterByName('prot') ? getParameterByName('prot') : false;

if (protid)
{
	$.ajax(
	{
		url: url,
		cache: false,
		data:
		{
			p: protid
		},
		success: function(result)
		{
			var lines = result.split("\n");
			$('#posey').hide();

			for (i=0; i<lines.length; i++)
            {
                var ln = lines[i];
				if (ln.substr(0, 6) == 'REMARK')
				{
					var pieces = ln.split(" ");
					if (pieces[2] == 'HELIX' && pieces[3].substr(0,3) == 'TMR')
					{
						var tmrno = parseInt(pieces[3].substr(-1));
						tmstart[tmrno] = parseInt(pieces[4]);
						tmend[tmrno] = parseInt(pieces[5]);
					}
					else if (pieces[3] == "LIGAND_BINDING")
					{
						var resno = parseInt(pieces[4]);
						ligbs.push(resno);
					}
					else if (pieces[3] == "BW")
					{
						var tmr = parseInt(pieces[4]);
						var resno = parseInt(pieces[5]);
						bw50r[tmr] = resno;
					}
					else if (pieces[3] == "MCOORD")
					{
						var resno = parseInt(pieces[4]);
						mcres.push(resno);
					}
				}
			}

			loadFile(result, protid+'.pdb');
		}
	});
}
else if (molid != "~")
{
	$.ajax(
	{
		url: url,
		cache: false,
		data:
		{
			m: molid
		},
		success: function(result)
		{
			$('#posey').show();
			$('#posey')[0].innerText = result.split("\n")[0];
			var stringBlob = new Blob( [ result ], { type: 'text/plain'} );
		    stage.loadFile( stringBlob, { ext: "sdf" } ).then( function( comp )
		    {
		        var rparam =
				{
		        	multipleBond: true,
					colorScheme: PODefSchemeHilite,
		        	metalness: mtl_bs,
		        }
		        comp.addRepresentation("ball+stick", rparam);
		        gmodel.push(comp);
				gmrep.push("ball+stick");
				gmrparams.push(rparam);
		        comp.autoView();
		    } );
		}
	});
}

function showPose(p)
{
    var i;

    var pnodz = $('#pnodz')[0];
    pnodz.innerHTML = "Node: ";
    var pmax = 1, nmax = 0;

    for (i=0; i<model.length; i++)
    {
        if (mpos[i] == p && mnod[i] == 0)
        {
			if (mrparams[i].colorScheme == PODefSchemeRainbow) mrparams[i].colorScheme = PODefSchemeLigand;
			model[i].removeAllRepresentations();
			var lrep = spcfill ? "spacefill" : mrep[i];
			var lparam = Object.assign({}, mrparams[i]);
			if (spcfill) lparam.opacity = 1;
            model[i].addRepresentation( lrep, lparam );
            if (is_ligand[i]) curr_ligand = model[i];
        }
        else
            if (model[i].name != 'ligand') model[i].removeAllRepresentations();

        if (mpos[i] > pmax) pmax = mpos[i];

        if ($("#nodebtn"+mnod[i]).length == 0)
		{
			if (mpos[i] == p )
			{
				var nodebtn = document.createElement("a");
				nodebtn.className = "nodebtn";
				if (mnod[i]==0) $(nodebtn).addClass("hilite");
				nodebtn.innerText = mnod[i];
				nodebtn.id = "nodebtn"+mnod[i];
				nodebtn.setAttribute("onclick", "showNode("+mnod[i]+");");

				pnodz.appendChild(nodebtn);

				if (mnod[i] > nmax) nmax = mnod[i];
			}
		}
    }

	if (nmax)
	{
		var rnbbtn = document.createElement("a");
		rnbbtn.className = "nodebtn";
		if (mnod[i]==0) $(rnbbtn).addClass("hilite");
		rnbbtn.innerText = "ðŸŒˆ";
		rnbbtn.id = "rnbbtn";
		rnbbtn.setAttribute("onclick", "rainbowNodes();");

		pnodz.appendChild(rnbbtn);
	}

    if (p < 1)
    {
        showPose(1);		// RECURSION!!!
        return;
    }

    if (p > pmax)
    {
        showPose(pmax);		// RECURSION!!!
        return;
    }

    gpose = p;
    gnode = 0;

    $(".posebtn").removeClass("hilite");
    $("#posebtn"+p).addClass("hilite");

    $("#clip").trigger("input");
    if (curr_ligand) $('#ligbtn, #prsv').show();
    
	set_gmdl_opacity();
}

function showNode(n)
{
    var i, bbi=-1;
    var nmax = 0;
    for (i=0; i<model.length; i++)
    {
        if (mpos[i] == gpose && mnod[i] == n)
        {
			if (mrparams[i].colorScheme == PODefSchemeRainbow) mrparams[i].colorScheme = PODefSchemeLigand;			// @#$% shallow copy.
			model[i].removeAllRepresentations();
			var lrep = spcfill ? "spacefill" : mrep[i];
			var lparam = Object.assign({}, mrparams[i]);
			if (spcfill) lparam.opacity = 1;
            model[i].addRepresentation( lrep, lparam );
            if (is_ligand[i]) curr_ligand = model[i];
        }
        else
		if (model[i].name != 'ligand') model[i].removeAllRepresentations();

        if (mpos[i] == gpose && mnod[i] > nmax) nmax = mnod[i];
    }

    if (n < 0)
    {
        showNode(0);		// RECURSION!!!
        return;
    }

    if (n > nmax)
    {
        showNode(nmax);		// RECURSION!!!
        return;
    }
    
    for (i=0; i<gmodel.length; i++)
    {
    	if (gmodel[i].name == "backbone")
    	{
    		bbi = i;
    		break;
    	}
    }

	// Cartoon for active protein conformational change.
    if (bbi >= 0 && acvmdl)
    {
		if (n >= acvnode)
		{
			if (!acvmdl.reprList.length) acvmdl.addRepresentation( "cartoon",
            {
                opacity: opc_cartoon,
				colorScheme: PODefRgnScheme,
                metalness: mtl_cartoon,
            });
            gmodel[bbi].removeAllRepresentations();
		}
		else
		{
			if (!gmodel[bbi].reprList.length) gmodel[bbi].addRepresentation( "cartoon",
            {
                opacity: opc_cartoon,
				colorScheme: PODefRgnScheme,
                metalness: mtl_cartoon,
            });
            acvmdl.removeAllRepresentations();
		}
    }

    $(".nodebtn").removeClass("hilite");
    $("#nodebtn"+n).addClass("hilite");

    gnode = parseInt(n);			// Givl upi Javascript from one sddjpar to another.

    $("#clip").trigger("input");
    if (curr_ligand) $('#ligbtn, #prsv').show();

	set_gmdl_opacity();
}

function rainbowNodes()
{
    var i, bbi=-1;
    var nmax = 0;

	gmodel[0].autoView();
	cen_ligand = false;

	$(".nodebtn").removeClass("hilite");
	$("#rnbbtn").addClass("hilite");

	// var cc = new NGL.ComponentCollection();

    for (i=0; i<model.length; i++)
    {
        if (mpos[i] == gpose && mnod[i] > nmax) nmax = mnod[i];
    }

    for (i=0; i<model.length; i++)
    {
        if (mpos[i] == gpose)
        {
			var mrp = mrparams[i];
			if (mrp.colorScheme == PODefSchemeLigand) mrp.colorScheme = PODefSchemeRainbow;
			model[i].removeAllRepresentations();
            model[i].addRepresentation( mrep[i], mrp );
            if (is_ligand[i])
			{
				if (mnod[i] == 0) curr_ligand = model[i];
			}
        }
        else
            model[i].removeAllRepresentations();
    }

	set_gmdl_opacity();
}

$("body").on("keyup", function(e, obj)
{
    var cc = e.key.charCodeAt(0);
    if (e.altkey || e.ctrlkey) return;

    if (e.keyCode >= 37 && e.keyCode <= 40)
    {
        if (e.keyCode == 37) showNode(gnode-1);
        if (e.keyCode == 38) showPose(gpose-1);
        if (e.keyCode == 39) showNode(gnode+1);
        if (e.keyCode == 40) showPose(gpose+1);
        e.preventDefault();
        return;
    }
    else
    {
        if (cc > 0x60 && cc <= 0x7a) showPose(cc-0x60);
        else if (cc >= 0x30 && cc <= 0x39) showNode(cc-0x30);
        else if (cc > 0x40 && cc <= 0x59) showNode(cc-55);
        e.preventDefault();
    }
});

$("#clip").on("input", function (e, obj)
{
    var i;
    var clipValue = get_clip_value();
    for (i=0; i<model.length; i++)
    {
        model[i].eachRepresentation( function(obj)
        {
            lcv = clipValue;
            if (is_ligand[i] && $("#preserve")[0].checked) lcv = 0;
            obj.setParameters( { "clipNear": lcv } );
        });
    }
    for (i=0; i<gmodel.length; i++)
    {
        gmodel[i].eachRepresentation( function(obj)
        {
            obj.setParameters( { "clipNear": clipValue } );
        });
    }
    if (acvmdl) acvmdl.eachRepresentation( function(obj)
    {
        obj.setParameters( { "clipNear": clipValue } );
    });
    for (i=0; i<resmdl.length; i++)
    {
    	resmdl[i].eachRepresentation( function(obj)
        {
            obj.setParameters( { "clipNear": clipValue } );
        });
	}
    stage.setParameters( { "fogNear": (clipValue), "fogFar": Math.max(25+clipValue, 200-clipValue*3), } );
});

$("#bbvis").on("input", function (e, obj)
{
	set_gmdl_opacity();
});

$("#lght").on("input", function (e, obj)
{
	var lint = parseFloat($("#lght")[0].value) / 100;
	stage.setParameters(
	{
		'lightIntensity': lint,
	});
});

function getFileContents(event)
{
    var ff = event.target.files;
	if (!ff.length) return;

    var f = ff[0];
    var r = new FileReader();
    r.fname = f.name;
    $('#ligbtn, #prsv').hide();

    r.onload = (function(lf)
    {
        return function(e)
        {
			window.setTimeout(function()
			{
				$("#clip").trigger("input");
			}, 259);
            return loadFile(e.target.result, e.target.fname);
        };
    })(f);
    r.readAsText(f);

	event.target.value = "";
	$("#posey")[0].innerText = f.name;
}

function loadFile(fileData, fileName = "")
{
	$("#pleasewait").show();
	window.setTimeout( function()
	{
		$("#pleasewait").hide();
	}, 5381);
	
	$("#affichage").hide();
	
    model = [];
	mrep = [];
	mrparams = [];
    gmodel = [];
	gmrep = [];
	gmrparams = [];
    curr_ligand = false;
	resmdl = [];
	mdlresno = [];
	restoggled = [];
	sequence = "";
	
	mdlresno.push(0);
	
    var fext = fileName.substr(fileName.lastIndexOf('.')+1);
    orid = false; // 'OR1A1';
    try
    {
        orid = fileName.match(/(OR[0-9]{1,2}[A-Z]{1,2}|TAAR|VN1R)[0-9]{1,2}/)[0];
    }
    catch (e)
    {
        ;
    }

    $.ajax(
    {
		url: "http://" + website + "/recepinfo.php",
		data:
        {
			recep: orid,
        },
		fext: fext,
		fileData: fileData,
		success: function(poresult)
        {
            poresult = poresult.split("\n");
			bw50r = new Array(99).fill(0);

            var i;
            for (i=0; i<poresult.length; i++)
            {
                var ln = poresult[i];
                if (ln.substr(0, 6) == "METAL|")
                {
                    var words = ln.split("|");
                    var j;
                    for (j=1; j<words.length; j++)
                    {
                        var m = words[j].match(/[0-9]{3}[:]/);
                        if (m && m.length)
                            mtlcoord.push(parseInt(m[0]));
                    }
                }
                if (ln.substr(0, 7) == "REGION|")
                {
                    var words = ln.split("|");
                    if (words[1].substr(0, 3) == "TMR")
                    {
                        var tmr = parseInt(words[1].substr(3));
                        tmstart[tmr] = parseInt(words[2]);
                        tmend[tmr] = parseInt(words[3]);
                    }
                }
                if (ln.substr(0, 3) == "BW|")
                {
                    var words = ln.split("|");
					var tmr = parseInt(words[1].split('.')[0]);
					bw50r[tmr] = parseInt(words[2]);
                }
                if (ln.substr(0, 7) == "POCKET|")
                {
                	if (!pocket[0] && !pocket[1] && !pocket[2])		// Only care about the first one for now.
                	{
                		var words = ln.split("|");
                		var j;
                		for (j=1; j<words.length; j++)
                		{
                			var kv = words[j].split('=');
                			if (kv.length > 1)
                			{
		            			if (kv[0] == 'center_x') pocket[0] = parseFloat(kv[1]);
		            			if (kv[0] == 'center_y') pocket[1] = parseFloat(kv[1]);
		            			if (kv[0] == 'center_z') pocket[2] = parseFloat(kv[1]);
		            			
		            			$('#pktbtn').show();
	            			}
                		}
                	}
                }
            }

            var fext = this.fext;
            switch (fext)
            {
		        case 'sdf':
		        case 'pdb':
                stage.removeAllComponents();
                window.result = fileData;
                cen_ligand = false;
				tmstart = [];
				tmend = [];
				ligbs = [];
				mcres = [];
				bw50r = new Array(99).fill(0);
                
                sequence = "";
                if (fext == 'pdb')
                {
					disable_spacefill();
                	var i;
                	var lines = fileData.split("\n");
                    var lres = 0;
                    var tmpstr = "";
					var ligtmp = "";
                    for (i=0; i<lines.length; i++)
                    {
                        var ln = lines[i];

                        if (ln.substr(0, 6) == "HETATM" || ln.substr(17,3) == "LIG")
                            ligtmp += ln + "\n";

						if (ln.substr(0, 6) == 'REMARK')
						{
							var pieces = ln.split(" ");
							if (pieces[2] == 'HELIX' && pieces[3].substr(0,3) == 'TMR')
							{
								var tmrno = parseInt(pieces[3].substr(-1));
								tmstart[tmrno] = parseInt(pieces[4]);
								tmend[tmrno] = parseInt(pieces[5]);
							}
							else if (pieces[3] == "LIGAND_BINDING")
							{
								var resno = parseInt(pieces[4]);
								ligbs.push(resno);
							}
							else if (pieces[3] == "BW")
							{
								var tmr = parseInt(pieces[4]);
								var resno = parseInt(pieces[5]);
								bw50r[tmr] = resno;
							}
							else if (pieces[3] == "MCOORD")
							{
								var resno = parseInt(pieces[4]);
								mcres.push(resno);
							}
						}
						else
                        {
							var resno = parseInt(ln.substr(22,4));

							if (lres != resno)
							{
								if (ln.length > 20)
								{
									var aa1let = aa_1let_from_3let(ln.substr(17,3).trim());
									if (aa1let != '?')
									{
										var stringBlob6 = new Blob( [tmpstr], { type: 'text/plain'} );
										stage.loadFile( stringBlob6, { ext: 'pdb' } ).then( function( comp6 )
										{
											resmdl.push(comp6);
											restoggled.push(0);
										});
										
										lres = resno;
										mdlresno.push(resno);
										tmpstr = "";
										while (sequence.length < resno-1) sequence += "-";
										sequence += aa1let;
									}
								}
							}
						}

                        if (ln.length < 20) continue;
                        
                        tmpstr += ln + "\n";
                    }
                    if (tmpstr)
                    {
	                	var stringBlob6a = new Blob( [tmpstr], { type: 'text/plain'} );
	                	stage.loadFile( stringBlob6a, { ext: 'pdb' } ).then( function( comp6a )
	            		{
	            			resmdl.push(comp6a);
	            			restoggled.push(0);
	            		});
	            		mdlresno.push(resno);
    				}

					if (ligtmp.length)
					{
						var stringBlob6b = new Blob( [ ligtmp ], { type: 'text/plain'} );
						stage.loadFile( stringBlob6b, { ext: 'pdb', name: "ligand" } ).then( function( comp6b )
						{
							var rparam =
							{
								opacity: opc_ligand,
								multipleBond: true,
								colorScheme: PODefSchemeLigand,
								metalness: mtl_bs,
							};

							model.push(comp6b);
							mrep.push("ball+stick");
							mrparams.push(rparam);
							is_ligand.push(1);
							curr_ligand = comp6b;

							var lpn = comp6b.name.split("|");
							mpos.push(parseInt(lpn[0]));
							mnod.push(parseInt(lpn[1]));
							$('#clip').trigger("input");

							curr_ligand.addRepresentation( "ball+stick", rparam );
						} );
						ligtmp = "";
					}
                    
                }
                
                if (fext == 'sdf')
                {
                	$('#posey').show();
					$('#posey')[0].innerText = fileData.split("\n")[0];
					enable_spacefill();
            	}
                
                var stringBlob = new Blob( [ fileData ], { type: 'text/plain'} );
                stage.loadFile( stringBlob, { ext: fext } ).then( function( comp )
                {
                    if (fext == 'sdf')
                    {
						var rp =
                        {
                        	opacity: opc_molecule,
							colorScheme: PODefSchemeHilite,
							multipleBond: true,
                        	metalness: mtl_bs,
                        };
                        comp.addRepresentation( "ball+stick", rp);
                        gmodel.push(comp);
						gmrep.push("ball+stick");
						gmrparams.push(rp);

                    	comp.autoView();
                    }

                    if (fext == 'pdb')
                    {
						var rp =
                        {
                            opacity: opc_cartoon,
							colorScheme: PODefRgnScheme,
                            // colorScale: 'rainbow',
                            metalness: mtl_cartoon,
                        };
                        comp.addRepresentation( "cartoon", rp);
                        gmodel.push(comp);
						gmrep.push("cartoon");
						gmrparams.push(rp);

                        var i;
                        var subset = [], shiny = [];
                        var result = window.result.split("\n");
                        for (i=0; i<result.length; i++)
                        {
                            var ln = result[i];
                            var resno = parseInt(ln.substr(22,4));
                            var aname = ln.substr(12,4).trim();
                            if (mtlcoord.indexOf(resno) >= 0
                                    && aname != "N"
                                    && aname != "HN"
                                    && aname != "H"
                                    && aname != "CA"
                                    && aname != "HA"
                                    && aname != "HA1"
                                    && aname != "HA2"
                                    // Due to a bug in NGL, the C and O atoms are required if including CA in
                                    // licorice, ball+stick, or line mode. Hyperball avoids this but is slower to render.
                                    // && aname != "C"
                                    // && aname != "O"
                               ) subset.push(ln);
                            if (ln.substr(17,3) == "MTL") shiny.push(ln);
                        }
                        /*var stringBlob1 = new Blob( [ subset.join("\n") ], { type: 'text/plain'} );
                        stage.loadFile( stringBlob1, { ext: 'pdb' } ).then( function( comp1 )
                        {
                            comp1.addRepresentation( "licorice",
                            {
                                opacity: opc_sidechain_active,
								colorScheme: PODefScheme,
                                metalness: mtl_licorice,
                            });
                            gmodel.push(comp1);
                        });*/
                        var stringBlob2 = new Blob( [ shiny.join("\n") ], { type: 'text/plain'} );
                        stage.loadFile( stringBlob2, { ext: 'pdb' } ).then( function( comp2 )
                        {
							var rp =
                            {
                                opacity: opc_metal,
								colorScheme: PODefScheme,
                                metalness: mtl_metal,
                            };
                            comp2.addRepresentation( "spacefill", rp);
                            gmodel.push(comp2);
							gmrep.push("spacefill");
							gmrparams.push(rp);
                        });

                    	comp.autoView();
                    }
                } );
                if (fext != 'sdf') $("#affichage").show();
                break;

            	case 'txt':
            	case 'dock':
                stage.removeAllComponents();
                var lines = fileData.split("\n");
                cen_ligand = true;
				disable_spacefill();
                
                var i;
                var mod = "m";
                for (i=0; i<100; i++)
                {
                	if (lines[i].substr(0, 10) == "PDB file: ")
                	{
                		if (lines[i].indexOf(".metal.") < 0) mod = "";
                		break;
            		}
                }

				var lln = lines.length;
				for (i=0; i<lln; i++)
				{
					if (lines[i] == "Original PDB:")
					{
						orid = false;
						var pdbdat = "";
						for (i++; i<lln; i++) pdbdat += lines[i] + "\n";
						apply_pdb(pdbdat);
					}
				}

				if (orid)
				{
		            $.ajax(
		            {
						url: "http://" + website + "/pdb.php",
						data:
		                {
							"p": orid,
							"mod": mod,
		                },
						success: function(poresult)
		                {
							apply_pdb(poresult);
		                }		// end orpdb success.
		            });		// end orpdb ajax.
	            }		// end if orid.

				$('#posey').show();
                var posey = $('#posey')[0];
                var i, writing=false, p=0, n=0;
                var protmp = "", ligtmp = "";
                posey.innerHTML = "Pose: ";
                model = [];
                is_ligand = [];
                mpos = [];
                mnod = [];
                for (i=0; i<lln; i++)
                {
                    var ln = lines[i];
					if (ln == "Original PDB:") break;

                    if (ln.substr(0,6) == "Pose: ")
                    {
                        p = parseInt(ln.substr(6));
                        ligtmp += "REMARK 225 " + ln + "\n";
                    }
                    else if (ln.substr(0,6) == "Node: ")
                    {
                        n = parseInt(ln.substr(6));
                        ligtmp += "REMARK 225 " + ln + "\n";
                    }
                    else if (ln.substr(0,4) == "ACM ")
                    {
                    	var words = ln.split(" ");
                    	if (words.length < 11) continue;
                    	
                    	acvnode = parseInt(words[1]);
                    	
                    	var matrixln =
                    	{
                    		name: words[2],
                    		sr: parseInt(words[3]),
                    		er: parseInt(words[4]),
                    		nx: parseFloat(words[5]),
                    		ny: parseFloat(words[6]),
                    		nz: parseFloat(words[7]),
                    		cx: parseFloat(words[8]),
                    		cy: parseFloat(words[9]),
                    		cz: parseFloat(words[10]),
                    	};
                    	
                    	if (!acvmatrix.length) acvmatrix.push(matrixln);
                    	else
                    	{
                    		var j;
                    		var found = false;
                    		for (j=0; j<acvmatrix.length; j++)
                    		{
                    			if (acvmatrix[j].name == matrixln.name)
                    			{
                    				acvmatrix[j] = matrixln;
                    				found = true;
                    				break;
                    			}
                    		}
                    		if (!found) acvmatrix.push(matrixln);
                    	}
                    }
                    else if (ln.substr(0,4) == "ACR ")
                    {
                    	var words = ln.split(" ");
                    	if (words.length < 11) continue;
                    	
                    	acvnode = parseInt(words[1]);
                    	
                    	acvmatrix = [];
                    	
                    	var rot8ln =
                    	{
                    		name: words[2],
                    		sr: parseInt(words[3]),
                    		er: parseInt(words[4]),
                    		tx: parseFloat(words[5]),			// transform xyz.
                    		ty: parseFloat(words[6]),
                    		tz: parseFloat(words[7]),
                    		ox: parseFloat(words[8]),			// origin xyz.
                    		oy: parseFloat(words[9]),
                    		oz: parseFloat(words[10]),
                    		ax: parseFloat(words[11]),			// axis xyz, relative to origin.
                    		ay: parseFloat(words[12]),
                    		az: parseFloat(words[13]),
                    		angle: parseFloat(words[14]),		// radians.
                    	};
                    	
                    	if (!acvrot8.length) acvrot8.push(rot8ln);
                    	else
                    	{
                    		var j;
                    		var found = false;
                    		for (j=0; j<acvrot8.length; j++)
                    		{
                    			if (acvrot8[j].name == rot8ln.name)
                    			{
                    				acvrot8[j] = rot8ln;
                    				found = true;
                    				break;
                    			}
                    		}
                    		if (!found) acvrot8.push(rot8ln);
                    	}
                	}
                    else if (ln.trim() == "PDBDAT:")
                    {
                        if (p>0) writing = true;
                    }
                    else if (ln.trim() == "END")
                    {
                        if (!n)
                        {
                        	var btnid = "posebtn"+p;
                        	
                        	if (!$('#'+btnid).length)
                        	{
		                        var posea = document.createElement("a");
		                        posea.className = "posebtn";
		                        if (p==1) $(posea).addClass("hilite");
		                        posea.innerText = p;
		                        posea.id = btnid;
		                        posea.setAttribute("onclick", "showPose("+p+");");

		                        posey.appendChild(posea);
                            }
                        }

                        if (writing)
                        {
                            var stringBlob7a = new Blob( [ protmp ], { type: 'text/plain'} );
                            stage.loadFile( stringBlob7a, { ext: 'pdb', name: p+"|"+n } ).then( function( comp7a )
                            {
                                var rparam =
                                {
                                    opacity: opc_sidechain_active,
									colorScheme: PODefSchemeHilite,
                                    metalness: mtl_licorice,
                                };

                                model.push(comp7a);
                                mrep.push("licorice");
                                mrparams.push(rparam);
                                is_ligand.push(0);

                                var lpn = comp7a.name.split("|");
                                mpos.push(parseInt(lpn[0]));
                                mnod.push(parseInt(lpn[1]));
                                $('#clip').trigger("input");
                            } );

                            var stringBlob7b = new Blob( [ ligtmp ], { type: 'text/plain'} );
                            stage.loadFile( stringBlob7b, { ext: 'pdb', name: p+"|"+n } ).then( function( comp7b )
                            {
                                var rparam =
                                {
									opacity: opc_ligand,
									multipleBond: true,
									colorScheme: PODefSchemeLigand,
                                    metalness: mtl_bs,
                                };

                                model.push(comp7b);
                                mrep.push("ball+stick");
                                mrparams.push(rparam);
                                is_ligand.push(1);
								if (!curr_ligand)
								{
									curr_ligand = comp7b;
									window.setTimeout(function()
									{
										showPose(1);
										// curr_ligand.autoView();
									}, 259);
								}

                                var lpn = comp7b.name.split("|");
                                mpos.push(parseInt(lpn[0]));
                                mnod.push(parseInt(lpn[1]));
                                $('#clip').trigger("input");
                            } );
                        }
                        writing = false;
                        protmp = ligtmp = "";
                    }
                    else if (writing)
                    {
                        if (ln.substr(0,6) == "HETATM" || ln.substr(17,3) == "LIG")
                            ligtmp += ln + "\n";
                        else
                            protmp += ln + "\n";
                    }
                }
                
                window.setTimeout(function()
                {
                    showPose(1);
                    // curr_ligand.autoView();
                }, 259);
                $("#affichage").show();
                break;

            	default:
                alert('Unknown file type ' + fext);
            }
            window.setTimeout(function()
            {
            	$("#pleasewait").hide();
                if (curr_ligand) curr_ligand.autoView();
            	$('#clip').trigger("input");
				showPose(1);
        	}, 916);

			$("#clip").trigger("input");
        }
    });
}

$('input[type=file]').on('input', getFileContents);
</script>

<div id="citefloat">
	<span>
	</span>
	<br>
	<a href="https://nglviewer.org/ngl/api/">Visualization using NGL Viewer</a>
</div>

<script>
$('#citefloat span')[0].innerText = nglcitation;
</script>

<div id="pleasewait" style="display: none;">
<h2>Please Wait...</h2>
<img src="http://www.primaryodors.org/imgs/Proton_Zundel.gif">
</div>

<div id="seqdd" style="display: none;">
</div>
